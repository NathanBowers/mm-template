////////////////////////////////////////
// GULP INIT
////////////////////////////////////////
var gulp = require('gulp');
var fsPath = require('fs-path');		// fsPath allows recursive and tolerant file/dir delete and create.
var del = require('del');
var sass = require('gulp-sass');
var concat = require('gulp-concat');
var sourcemaps = require('gulp-sourcemaps');
var autoprefixer = require('gulp-autoprefixer');
var cssmin = require('gulp-cssmin');
var rename = require('gulp-rename');
var browserSync = require('browser-sync').create();
var runSequence = require('run-sequence');
var open = require('gulp-open');
var touch = require('gulp-touch');
var svgSprite = require('gulp-svg-sprite');
var plumber = require('gulp-plumber');

var autoprefixerOptions = {
	browsers: ['last 2 versions', '> 5%']
};

////////////////////////////////////////
// DEFAULT GULP BUILD TASK, RUNS WHEN "MIDDLEMAN" COMMAND RUNS IN TERMINAL
////////////////////////////////////////
gulp.task('default', function(callback) {
	runSequence('clean:cleanBuild', 'svgSprite', 'sass', 'scripts', 'copyFonts', 'copyBitmaps', ['watch'], callback);
});

////////////////////////////////////////
// "STATIC BUILD" GULP BUILD TASK, RUNS WHEN "MIDDLEMAN BUILD" COMMAND RUNS IN TERMINAL
////////////////////////////////////////
gulp.task('buildProd', function(callback) {
	runSequence('clean:cleanBuild', 'svgSprite', 'sass', 'scripts', 'copyFonts', 'copyBitmaps', callback);
});

////////////////////////////////////////
// GULP TASKS BELOW
////////////////////////////////////////
gulp.task('clean:cleanBuild', function () {			// <-- Used at gulp startup to delete folders and files generated by previous gulp instances
	return del([
		'source/dist/**'							// <-- More files you could clean: 'data/temp.json', 'source/javascripts/application.js'
	]);
});

gulp.task('scripts', function() {		// <-- This blog concatenates .js files and put them in 'dist'
	return gulp.src([
		'source/js/*.js'
	])
	.pipe(concat('all.js'))
	.pipe(gulp.dest('source/dist/js/'));
});

gulp.task('sass', function() {
	return gulp
	.src('source/sass/**/*.+(scss|sass)')		// <-- Gets all files ending with .sass or .scss in app/scss and children dirs
	.pipe(sourcemaps.init())					// <-- Enables sourcemap for later output
	.pipe(sass().on('error', sass.logError))	// <-- Make sure to use sass.logError so gulp.js 'watch' task doesn't die when there's a Sass build error.
	.pipe(autoprefixer(autoprefixerOptions))	// <-- Autoprefix the resultant .css
	.pipe(cssmin()) 							// <-- Minify .css
	.pipe(rename({suffix: '.min'})) 			// <-- Rename minified file to .min.css
	.pipe(sourcemaps.write('maps/'))			// <-- Turn on .css source map
	.pipe(gulp.dest('source/dist/css/'));		// <-- Output the completed .css file
});

gulp.task('copyFonts', function() {
	gulp.src('source/fonts/**/*.{ttf,woff,woff2,eof}')
	.pipe(gulp.dest('./source/dist/fonts/'));
});

gulp.task('copyBitmaps', function() {
	gulp.src('source/images/*.{png,jpg,jpeg,gif,svg}')
	.pipe(gulp.dest('./source/dist/images/'));
});

gulp.task('touchConfig', function() {
	gulp.src('config.rb').pipe(touch()); 		// <-- Touch config.rb on gulpfile.js save so Middleman reloads everything.
});

gulp.task('svgSprite', function() {
	fsPath.writeFileSync('source/dist/css/_svg-sprite.scss', ' ');		// <-- In case no sprites are in the sprites folder, create the .scss so it doesn't break Sass compile.
	baseDir	  = 'source/images/svg-sprite',								// <-- Set to your SVG base directory
	svgGlob	  = '**/*.svg',	   											// <-- Glob to match your SVG files
	outDir	   = './source/dist/images/svg-sprite',						// <-- Main output directory
	config	   = {
		dest: '.',
		mode: {
			view: {														// <-- Use "view" mode for "css" svg sprites that can be used as inline images also.
				dest: '../',
				sprite: '../images/svg-sprite/global-sprite.svg',		// <-- Paths are tricky http://stackoverflow.com/questions/29838150/modifying-destination-and-filename-of-gulp-svg-sprite
				bust: false,											// <-- Turn off Cache busting
				layout: 'packed',										// <-- Pack the svg shapes tightly spaced in the sprite
				example: true,											// <-- Render out a sample .html file to /source/sass/sprites/ showing the sprites
				render: {
					scss: {
						dest: '../css/_svg-sprite.scss'					// <-- Output the scss file that will be imported into the main sass
					}
				}
			},
			symbol: {
				layout: 'packed',
				example: true
			}
		}
	};

	return gulp.src(svgGlob, {cwd: baseDir})
		.pipe(plumber())
		.pipe(svgSprite(config)).on('error', function(error){ console.log(error); })	// <-- Plumber error handler, everyone says so
		.pipe(gulp.dest(outDir))														// <-- Output the files
});


////////////////////////////////////////
// BrowserSync lives inside the watch task. Much better this way because of css watch/browsersync reload concurrency issues. See below
////////////////////////////////////////
gulp.task('watch', ['sass'], function(gulpCallback) {
	// Changed browserSync and watch function based on http://paulsalaets.com/posts/injecting-styles-in-page-with-browser-sync
	// Now it's much better. No Sass/CSS watch task concurrency problems with BrowserSync/Gulp/Middleman.
	// Streamed .css and image files (aka live reloading) should now just work, no "double save" needed.
	browserSync.init({
		proxy: "localhost:4567",	// <-- Proxy local running Middleman server.
		open: false, 				// <-- Launch default browser on BrowserSync init.
		reloadDelay: 100,			// <-- Seems to help, concurrency Voodoo. Probably.
		reloadDebounce: 500,		// <-- Seems to help, concurrency Voodoo. Probably.
		reloadOnRestart: true,
		files: ["source/**/*.erb", "source/**/*.slim", "source/**/*.html", "source/dist/css/*.css", "source/dist/js/*.js", "source/dist/**/*.+(svg|jpg|jpeg|png|gif|ttf|woff|woff2|eof)", "!static-build-output/**/*.*"], // Use BrowserSync instead of gulp watchers to watch static files.
		port: 7000,			// <-- The port the BrowserSync proxy runs on.
		ui: {
			port: 7001		// <-- Port that BrowserSync UI tools runs on.
		},
	}, function callback() {
		// (server is now up)
		gulp.watch('config.rb', browserSync.exit); 										// <-- Exit BrowserSync on config.rb change
		gulp.watch('source/sass/**/*.+(scss|sass)', ['sass']);							// <-- Watch Sass/Scss
		gulp.watch('source/js/*.js', ['scripts']);										// <-- Watch js
		gulp.watch('source/images/**/*.svg', ['svgSprite']);							// <-- Watch svg
		gulp.watch('source/images/*.+(jpg|jpeg|png|gif|svg)', ['copyBitmaps']);			// <-- Watch png, jpg, gif, non-sprite svg
		gulp.watch('source/fonts/**/*.+(ttf|woff|woff2|eof)', ['copyFonts']);			// <-- Watch fonts
		gulp.watch('gulpfile.js', ['touchConfig']);										// <-- "Touch" config.rb on gulpfile.js save so Middleman reloads

		gulpCallback();		// <-- Notify gulp that this task is done
	});
});
